<?php

namespace App\Http\Livewire\Site\Pages;

use App\Models\AttributeItem;
use App\Models\Catalog;
use App\Models\Category;
use App\Models\Product;
use App\Models\Tag;
use Artesaos\SEOTools\Facades\SEOMeta;
use Illuminate\Support\Facades\DB;
use Livewire\Component;
use Livewire\WithPagination;

class CategoryPage extends Component
{
    use WithPagination;

    public $category;
    public $catalog;
    public $brands;
    public $tags;
    public $allAttributes;
    public $attributesRangeOn = false;
    public $attributesRange;
    public $attributesRanges = [];
    private $attrsGroupFilters = []; // –ì—Ä—É–ø–∏—Ä—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞

    public $shelterUrgentlyRequired = false; // –°—Ä–æ—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏—é—Ç–∞ 2546
    public $shelterMarkdown = false; // –£—Ü–µ–Ω–∫–∞ –¥–ª—è –ø—Ä–∏—é—Ç–∞

    public $promoF = false;
    public $attrsF = []; // –°–æ–±–∏—Ä–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    public $brandsF = [];
    public $stockF = 3;

    public $showPromoF = true; // TODO —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
    public $maxPrice = 10000;
    public $minPrice = 0;
    public $maxRange = 10000;
    public $minRange = 0;
    public $sortSelectedName = '–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏';
    public $sortSelectedType = 'popularity';
    public $sortBy = 'desc';
    public $tag = [];
    public $charity = false;
    public $sortType = [
        '0' => [
            'name' => '–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏',
            'type' => 'popularity',
            'sort' => 'desc',
        ],
        '1' => [
            'name' => '–ù–∞–∑–≤–∞–Ω–∏–µ: –æ—Ç –ê –¥–æ –Ø',
            'type' => 'name',
            'sort' => 'asc',
        ],
        '2' => [
            'name' => '–ù–∞–∑–≤–∞–Ω–∏–µ: –æ—Ç –Ø –¥–æ –ê',
            'type' => 'name',
            'sort' => 'desc',
        ],
        '3' => [
            'name' => '–¶–µ–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é',
            'type' => 'price_avg',
            'sort' => 'asc',
        ],
        '4' => [
            'name' => '–¶–µ–Ω–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é',
            'type' => 'price_avg',
            'sort' => 'desc',
        ],
    ];
    protected $queryString = [
        'attrsF' => ['except' => ''],
        'brandsF' => ['except' => ''],
        'page' => ['except' => 1],
        'promoF' => ['except' => ''],
        'stockF' => ['except' => ''],
    ];
    protected $listeners = ['updatedMinMaxPrice', 'updatedMinMaxRange', ];

    public function mount($catalogslug, $categoryslug, $tagslug = null)
    {
        $this->category = Category::where('slug', $categoryslug)
            ->with(['tags' => function ($query) {
                $query->where('show_on_page', true);
            }])
            ->firstOrFail();

        $this->tags = $this->category->tags->toArray();

        $this->catalog = Catalog::where('slug', $catalogslug)
            ->select('id', 'slug', 'name')
            ->firstOrFail()->toArray();

        if ($tagslug !== null) {
            $this->tag = Tag::where('slug', $tagslug)->firstOrFail();
        }

        $this->setMaxAndMinPrices();

        $this->getBrands($this->category->products);

        $this->name = $this->category->name;

        $this->setSeo();
    }

    public function setMaxAndMinPrices()
    {
        $variationsId = $this->category->products()
            ->isStatusActive()
            ->has('media')
            ->with('variations', fn ($q) => $q->hasStock())
            ->whereHas('variations', fn ($q) => $q->hasStock())
            ->get()
            ->pluck('variations')
            ->flatten()
            ->unique('id')
            ->pluck('id');

        $this->maxPrice = \DB::table('products_1c')
            ->whereIn('id', $variationsId)
            ->max('price');

        $this->minPrice = \DB::table('products_1c')
            ->whereIn('id', $variationsId)
            ->where('price', '>', 0)
            ->min('price');

        $this->maxRange = $this->maxPrice;
        $this->minRange = $this->minPrice;
    }

    public function setSeo()
    {
        if (!empty($this->tag)) {
            $this->getTagFilters();

            // SEO TITLE
            // *like* –Ø–Ω–¥–µ–∫—Å title + –∫—É–ø–∏—Ç–µ –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Å–ø–± —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π + (—Ü–µ–Ω–∞ –æ—Ç ...) + *–¥–æ–ª–ª–∞—Ä* –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ + –ø–µ—Ç—à–æ–ø—ã –≤ –ù–µ–≤—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç

            $metaTitle = 'üëç '
            . $this->tag->meta_title
            . ' –∫—É–ø–∏—Ç–µ –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Å–ø–± —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) . ' ‚ÇΩ), –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏, –ø–µ—Ç—à–æ–ø—ã –≤ –ù–µ–≤—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç';

            //SEO DESCRIPTION
            // *like* –Ø–Ω–¥–µ–∫—Å title + (–≤ –Ω–∞–ª–∏—á–∏–∏) –∫—É–ø–∏—Ç–µ –≤ —Å–ø–± + *—Å–∞–º–æ–ª–µ—Ç–∏–∫* —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö  (—Ü–µ–Ω–∞ –æ—Ç ...) + *–≥–∞–ª–æ—á–∫–∞* —Ñ–æ—Ç–æ, —Å–æ—Å—Ç–∞–≤—ã, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ* + *–¥–æ–ª–ª–∞—Ä* –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ *—Å–µ—Ä–¥–µ—á–∫–æ* –¥—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –≥–∞—Ä–∞–Ω—Ç–∏–∏ *—Å–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ù–µ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç

            $metaDescription = 'üëç '
            . $this->tag->meta_title .
            ' (–≤ –Ω–∞–ª–∏—á–∏–∏) –∫—É–ø–∏—Ç–µ –≤ —Å–ø–± üöö —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) .
            ' —Ä—É–±–ª–µ–π) ‚ùó —Ñ–æ—Ç–æ, —Å–æ—Å—Ç–∞–≤—ã, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ, ‚ÇΩ –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ üß° –¥—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –≥–∞—Ä–∞–Ω—Ç–∏–∏, —Å–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ù–µ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç';

            SEOMeta::setTitle($metaTitle)->setDescription($metaDescription);
        } else {
            if ($this->catalog['id'] === 14) {
                // SEO TITLE
                // –ö—É–ø–∏—Ç–µ –∫–æ—Ä–º –¥–ª—è –ø–∏—Ç–æ–º–Ω–∏–∫–∞ –∏ –ø—Ä–∏—é—Ç–∞ –¥–ª—è —Å–æ–±–∞–∫ –∏ –∫–æ—à–µ–∫ –≤ —Å–ø–± + (—Ü–µ–Ω–∞  –æ—Ç ...) + –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –ó–æ–æ–ø–æ–¥–∞—Ä–∫–∏ *–¥–æ–ª–ª–∞—Ä* –ê–∫—Ü–∏–∏, –°–∫–∏–¥–∫–∏, –†–∞—Å–ø—Ä–æ–¥–∞–∂–∏, –î—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

                $metaTitle = '–ö—É–ø–∏—Ç–µ –∫–æ—Ä–º –¥–ª—è –ø–∏—Ç–æ–º–Ω–∏–∫–∞ –∏ –ø—Ä–∏—é—Ç–∞ –¥–ª—è —Å–æ–±–∞–∫ –∏ –∫–æ—à–µ–∫ –≤ —Å–ø–± (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) . ' —Ä—É–±–ª–µ–π) –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –ó–æ–æ–ø–æ–¥–∞—Ä–∫–∏ ‚ÇΩ –ê–∫—Ü–∏–∏, –°–∫–∏–¥–∫–∏, –†–∞—Å–ø—Ä–æ–¥–∞–∂–∏, –î—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ';

                //SEO description
                // *—Å–µ—Ä–¥–µ—á–∫–æ* –ö—É–ø–∏—Ç–µ –∫–æ—Ä–º –¥–ª—è –ø–∏—Ç–æ–º–Ω–∏–∫–∞ –∏ –ø—Ä–∏—é—Ç–∞ –¥–ª—è —Å–æ–±–∞–∫ –∏ –∫–æ—à–µ–∫ –≤ —Å–ø–± + (—Ü–µ–Ω–∞  –æ—Ç ...) + –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –ó–æ–æ–ø–æ–¥–∞—Ä–∫–∏ *–¥–æ–ª–ª–∞—Ä* –ê–∫—Ü–∏–∏, –°–∫–∏–¥–∫–∏, –†–∞—Å–ø—Ä–æ–¥–∞–∂–∏

                $metaDescription = 'üß°  '
            . $this->category->meta_description .
            ' –ö—É–ø–∏—Ç–µ –∫–æ—Ä–º –¥–ª—è –ø–∏—Ç–æ–º–Ω–∏–∫–∞ –∏ –ø—Ä–∏—é—Ç–∞ –¥–ª—è —Å–æ–±–∞–∫ –∏ –∫–æ—à–µ–∫ –≤ —Å–ø–± (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) .
            ' —Ä—É–±–ª–µ–π) –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –ó–æ–æ–ø–æ–¥–∞—Ä–∫–∏ ‚ÇΩ –ê–∫—Ü–∏–∏, –°–∫–∏–¥–∫–∏, –†–∞—Å–ø—Ä–æ–¥–∞–∂–∏';
            } else {
                // SEO TITLE
                // *like* –¥–ª—è SEO title + –∫—É–ø–∏—Ç–µ + –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Å–ø–± —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π (—Ü–µ–Ω–∞ –æ—Ç ) +*–¥–æ–ª–ª–∞—Ä* –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ + –ø–µ—Ç—à–æ–ø—ã –≤ –ù–µ–≤—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç

                $metaTitle = 'üëç '
            . $this->category->meta_title
            . ', –∫—É–ø–∏—Ç–µ –≤ –Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–æ–º–∞–≥–∞–∑–∏–Ω–µ —Å–ø–± —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) . ' ‚ÇΩ) –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ + –ø–µ—Ç—à–æ–ø—ã –≤ –ù–µ–≤—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç';

                //SEO description
                // *like* –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è SEO description + –∫—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Å–ø–± *—Å–∞–º–æ–ª–µ—Ç–∏–∫* —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π *–≥–∞–ª–æ—á–∫–∞* —Ñ–æ—Ç–æ, —Å–æ—Å—Ç–∞–≤—ã, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ* + *–¥–æ–ª–ª–∞—Ä* –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ *—Å–µ—Ä–¥–µ—á–∫–æ* –¥—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –≥–∞—Ä–∞–Ω—Ç–∏–∏ *—Å–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ù–µ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç

                $metaDescription = 'üëç '
            . $this->category->meta_description .
            ' –∫—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∫–æ—Ä–º–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ —Å–ø–± üöö —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π‚ùó (—Ü–µ–Ω–∞ –æ—Ç '
            . discount($this->minPrice, 5) .
            ' —Ä—É–±–ª–µ–π) —Ñ–æ—Ç–æ, —Å–æ—Å—Ç–∞–≤—ã, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ, –¥–æ–∑–∏—Ä–æ–≤–∫–∞, ‚ÇΩ –∞–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏ üß° –¥—É—à–µ–≤–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –≥–∞—Ä–∞–Ω—Ç–∏–∏, üöö —Å–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –ù–µ–≤—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞, –º–µ—Ç—Ä–æ –ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, –º–µ—Ç—Ä–æ –õ–∞–¥–æ–∂—Å–∫–∞—è –∏ –º–µ—Ç—Ä–æ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç';
            }



            SEOMeta::setTitle($metaTitle)->setDescription($metaDescription);
        }
    }

    public function getBrands($products)
    {
        $brands_ids = $products
            ->pluck('brand_id')
            ->flatten()
            ->unique()
            ->flatten()
            ->all();

        $this->brands = DB::table('brands')
            ->whereIn('id', $brands_ids)
            ->orderBy('name', 'asc')
            ->get(['id', 'name']);
    }

    public function getAttributes($productAttributes = [])
    {
        $allAttributes = $this->category->filters($productAttributes);

        $this->attributesRange = $allAttributes
            ->where('range', 1)->flatten()->toArray();

        foreach ($allAttributes->where('range', 1)->pluck('items') as $key => $item) {
            array_push(
                $this->attributesRanges,
                [
                    'id' => $this->attributesRange[$key]['id'],
                    'name' => $this->attributesRange[$key]['name'],
                    'max' => str_replace(',', '.', $item->max('name')),
                    'min' => str_replace(',', '.', $item->min('name')),
                ],
            );
        }

        $this->allAttributes = $allAttributes->where('range', 0)->toArray();
    }

    public function setAttFilter($attrsF = [])
    {
        $this->attrsF = array_unique($attrsF);

        $attFilters = AttributeItem::whereIn('id', $attrsF)
            ->get();

        $this->attrsGroupFilters = $attFilters->mapToGroups(function ($item) {
            return [$item['attribute_id'] => $item['id']];
        });

        $this->attrsGroupFilters = $this->attrsGroupFilters->toArray();
    }

    public function updatedMinMaxPrice($minPrice, $maxPrice)
    {
        $this->minPrice = (int)$minPrice;
        $this->maxPrice = (int)$maxPrice;
    }


    public function updatedMinMaxRange($minRange, $maxRange, $key)
    {
        $this->attributesRanges[$key]['min'] = $minRange;
        $this->attributesRanges[$key]['max'] = $maxRange;
        $this->attributesRangeOn = true;
    }


    public function sortIt($type, $sort, $name)
    {
        $this->sortSelectedType = $type;
        $this->sortSelectedName = $name;
        $this->sortBy = $sort;
    }

    public function resetFilters()
    {
        $this->reset([
            'attrsF',
            'brandsF',
            'promoF',
            'stockF',
            'attributesRanges',
            'allAttributes',
        ]);
        $this->setMaxAndMinPrices();
        $this->resetPage();

        $this->dispatchBrowserEvent('reset-range');
        $this->dispatchBrowserEvent('reset-range-attr');
    }

    public function getTagFilters()
    {
        foreach ($this->tag->filter as $filter) {
            array_push($this->attrsF, $filter['id']);
        }
        $this->resetPage();
    }

    public function getProducts()
    {
        return Product::isStatusActive()
            ->select(['id', 'name', 'slug', 'brand_id', 'brand_serie_id', 'unit_id', 'discount_weight'])
            ->has('media')
            ->has('categories')
            ->has('variations')
            ->whereHas('categories', fn ($q) => $q->where('category_id', $this->category->id))

            ->when($this->brandsF, function ($query) {
                $query->whereIn('brand_id', $this->brandsF);
            })
            ->with('attributes')
            // TODO –Ω–µ—Ä–∞–±–æ—Ç–∞–µ—Ç
            ->when($this->attributesRangeOn, function ($query) {
                $query->whereHas('attributes', function ($query) {
                    foreach ($this->attributesRanges as $range) {
                        $query->where(
                            'attribute_item.attribute_id',
                            $range['id']
                        )
                        ->whereBetween('attribute_item.name', [
                            $range['min'],
                            $range['max'],
                        ]);
                    }
                });
            })

             ->when($this->shelterUrgentlyRequired, function ($query) {
                 $query->whereHas('attributes', fn ($q) => $q->where('attribute_item.id', 2546));
             })

            ->whereHas('variations', function ($query) {
                $query->whereBetween('price', [$this->minPrice, $this->maxPrice])
                ->when($this->promoF, function ($query) {
                    $query->where('promotion_type', '>', 0);
                })
                ->when($this->shelterMarkdown, function ($query) {
                    $query->where('promotion_type', 1);
                });
            })

            ->when($this->attrsF, function ($query) {
                foreach ($this->attrsGroupFilters as $ids) {
                    $query->whereHas('attributes', fn ($q) => $q->whereIn('attribute_item.id', $ids));
                }
            })

            ->when($this->stockF, function ($query) {
                $query->checkStock((int) $this->stockF);
            })
              //  ->with(['media' => function ($query) { $query->unique('model_id'); }])
                ->with('media:id,model_id,model_type,collection_name,disk,conversions_disk,generated_conversions,file_name')
                ->with('brand:id,name,slug')
                ->with('unit:id,name')
                ->with('variations:id,product_id,price,promotion_type,unit_value,promotion_percent,stock')
                ->orderBy($this->sortSelectedType, $this->sortBy)
                ->paginate(32);
    }

    public function updated()
    {
        $this->resetPage();
    }

    public function render()
    {
        $this->setAttFilter($this->attrsF);

        $products = $this->getProducts();


        $this->getAttributes($products->pluck('attributes')->flatten()->pluck('id')->unique()->values()->toArray());

        if ($products->total() < 5) {
            SEOMeta::setRobots('noindex, nofollow');
        }

        $this->emit('lozad', '');

        return view('livewire.site.pages.category-page', [
            'products' => $products,
        ])
                    ->extends('layouts.app')
                    ->section('content');
    }
}
